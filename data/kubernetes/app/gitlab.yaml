---
include:
  - 'nest::service::gitlab'

ceph_namespace: rook-ceph
ceph_object_store: ceph-objectstore
cert_issuer: eyrie-ca
cert_issuer_kind: ClusterIssuer
external_name: "%{nest::kubernetes::fqdn}"
ingress_class: contour-workstation
node_role: workstation
service_name: "%{nest::kubernetes::service}"

resources:
  certs:
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: "%{nest::kubernetes::service}-certs"
      namespace: "%{nest::kubernetes::namespace}"
    spec:
      secretName: "%{nest::kubernetes::service}-certs"
      issuerRef:
        name: "%{lookup('cert_issuer')}"
        kind: "%{lookup('cert_issuer_kind')}"
      dnsNames:
        - "%{nest::kubernetes::fqdn}"
        - "*.%{nest::kubernetes::fqdn}"

  backups-storage-secret:
    apiVersion: v1
    kind: Secret
    metadata:
      name: "%{nest::kubernetes::service}-backups-storage"
      namespace: "%{nest::kubernetes::namespace}"
    data:
      config: "%{nest::service::gitlab::backups_config_base64}"

  object-storage-secret:
    apiVersion: v1
    kind: Secret
    metadata:
      name: "%{nest::kubernetes::service}-object-storage"
      namespace: "%{nest::kubernetes::namespace}"
    data:
      connection: "%{nest::service::gitlab::object_store_connection_base64}"

  registry-storage-secret:
    apiVersion: v1
    kind: Secret
    metadata:
      name: "%{nest::kubernetes::service}-registry-storage"
      namespace: "%{nest::kubernetes::namespace}"
    data:
      config: "%{nest::service::gitlab::registry_config_base64}"

values:
  global:
    edition: ce
    hosts:
      domain: "%{nest::kubernetes::fqdn}"
      gitlab:
        name: "%{lookup('external_name')}"
        hostnameOverride: "%{nest::kubernetes::fqdn}"
      registry:
        name: "registry.%{lookup('external_name')}"
      ssh: "%{lookup('external_name')}"
    ingress:
      configureCertmanager: false
      class: "%{lookup('ingress_class')}"
      provider: contour # default 'nginx' affects default annotations
      tls:
        secretName: "%{nest::kubernetes::service}-certs"
    minio:
      enabled: false
    appConfig:
      artifacts:
        bucket: "%{nest::service::gitlab::artifacts_bucket_config.BUCKET_NAME}"
        connection:
          secret: "%{nest::kubernetes::service}-object-storage"
      backups:
        bucket: "%{nest::service::gitlab::backups_bucket_config.BUCKET_NAME}"
        tmpBucket: "%{nest::service::gitlab::backups_tmp_bucket_config.BUCKET_NAME}"
      lfs:
        bucket: "%{nest::service::gitlab::lfs_bucket_config.BUCKET_NAME}"
        connection:
          secret: "%{nest::kubernetes::service}-object-storage"
      packages:
        bucket: "%{nest::service::gitlab::packages_bucket_config.BUCKET_NAME}"
        connection:
          secret: "%{nest::kubernetes::service}-object-storage"
      uploads:
        bucket: "%{nest::service::gitlab::uploads_bucket_config.BUCKET_NAME}"
        connection:
          secret: "%{nest::kubernetes::service}-object-storage"
    registry:
      bucket: "%{nest::service::gitlab::registry_bucket_config.BUCKET_NAME}"
    shell:
      hostKeys:
        secret: "%{nest::kubernetes::service}-shell-host-keys"
    storageClass: data-crypt
  installCertmanager: false
  prometheus:
    server:
      persistentVolume:
        storageClass: data-crypt
  gitlab:
    gitaly:
      persistence:
        storageClass: data-crypt
    gitlab-shell:
      service:
        type: LoadBalancer
        loadBalancerIP: "%{nest::service::gitlab::ssh_load_balancer_ip}"
    toolbox:
      backups:
        objectStorage:
          config:
            secret: "%{nest::kubernetes::service}-backups-storage"
    webservice:
      image:
        pullSecrets:
          - name: "%{nest::kubernetes::service}-registry-auths"
      ingress:
        annotations:
          projectcontour.io/response-timeout: infinity
      workhorse:
        image: "%{lookup('registry')}/nest/forks/gitlab-workhorse"
  gitlab-runner:
    install: false
  nginx-ingress:
    enabled: false
  registry:
    hostname: "registry.%{nest::kubernetes::fqdn}"
    ingress:
      annotations:
        projectcontour.io/response-timeout: infinity
      tls:
        secretName: "%{nest::kubernetes::service}-certs"
    storage:
      secret: "%{nest::kubernetes::service}-registry-storage"
      redirect:
        disable: true
    database:
      enabled: true
      name: registry
      user: registry
      password:
        secret: "%{nest::kubernetes::service}-registry-database-password"
        key: password

patches:
  # Eyrie is a small cluster and this is not a major app
  10-disable-hpa:
    patch:
      kind: not-important
      metadata:
        name: not-important
      $patch: delete
    target:
      kind: HorizontalPodAutoscaler

  # Supposedly there are global values for this, but I can't get them to work
  # and it doesn't expose tolerations in all cases anyway.
  # See: https://docs.gitlab.com/charts/charts/gitlab/index.html#affinity
  10-placement:
    # Patching multiple generic resources
    # See: https://stackoverflow.com/a/74860413
    patch:
      kind: not-important
      metadata:
        name: not-important
      spec:
        template:
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                      - key: "node-role.kubernetes.io/%{lookup('node_role')}"
                        operator: Exists
            tolerations:
              - key: "node-role.kubernetes.io/%{lookup('node_role')}"
                operator: Exists
                effect: NoSchedule
    target:
      kind: (Deployment|StatefulSet|Job)

  # Disable Kubernetes service-link environment variables to prevent REGISTRY_*
  # collisions that break GitLab Registry startup.
  10-registry-disable-service-links:
    patch:
      kind: not-important
      metadata:
        name: not-important
      spec:
        template:
          spec:
            enableServiceLinks: false
    target:
      kind: (Deployment|Job)
      labelSelector: app in (registry, registry-migrations)

  10-registry-ingress-override:
    patch:
      - op: replace
        path: /spec/rules/0/host
        value: "registry.%{nest::kubernetes::fqdn}"
      - op: replace
        path: /spec/tls/0/hosts/0
        value: "registry.%{nest::kubernetes::fqdn}"
    target:
      group: networking.k8s.io
      version: v1
      kind: Ingress
      name: "%{nest::kubernetes::service}-registry"

  # This job is a good place to run the init, but it can't be patched like a
  # deployment. Delete it manually and redeploy to toggle off the init flag.
  10-nest:
    patch:
      - op: add
        path: '/metadata/labels/james.tl~1nest'
        value: 'init-only'
    target:
      kind: Job
      labelSelector: 'app=migrations'

  20-nest: [] # Do not run Nest sidecar
