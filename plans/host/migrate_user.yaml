---
description: 'Rename user and home directory'

parameters:
  targets:
    type: TargetSpec
    description: 'Targets to migrate the user on'

steps:
  - description: 'Stop services'
    command: systemctl stop greetd puppet-run.serivce puppet-run.timer || true
    run_as: root
    targets: $targets

  - description: 'Kill all processes of the user'
    command: loginctl kill-user james || true
    run_as: root
    targets: $targets

  - description: 'Rename home dataset'
    command: bash -c 'rpool=$(facter -p rpool); test -d /home/joy || zfs rename ${rpool}/home/james ${rpool}/home/joy'
    run_as: root
    targets: $targets

  - description: 'Create home symlink'
    command: bash -c 'cd /home && ln -sf joy james'
    run_as: root
    targets: $targets

  - description: 'Remove systemd linger file'
    command: rm -f /var/lib/systemd/linger/james
    run_as: root
    targets: $targets

  - description: 'Rename user'
    command: sed -i 's/james/joy/' /etc/group /etc/gshadow* /etc/passwd /etc/shadow*
    run_as: root
    targets: $targets

  - description: 'Update /root repo'
    command: bash -c 'cd /root && git remote set-url origin https://gitlab.james.tl/joy/dotfiles.git'
    run_as: root
    targets: $targets

  - description: 'Update /home/joy repo'
    command: bash -c 'cd /home/joy && git remote set-url origin https://gitlab.james.tl/joy/dotfiles.git'
    run_as: joy
    targets: $targets

  - description: 'Run Puppet'
    plan: nest::puppet::run
    targets: $targets

  - description: 'Reboot'
    plan: nest::host::reboot
    targets: $targets
