---
description: 'Deploy test ingress'

parameters:
  deploy:
    description: 'Run or skip the deployment'
    type: Boolean
    default: true

  contour:
    description: 'Deploy Contour'
    type: Boolean
    default: true

  certmanager:
    description: 'Deploy cert-manager'
    type: Boolean
    default: true

  ca:
    description: 'Deploy CA config'
    type: Boolean
    default: true

  render_to:
    description: 'Just render the template'
    type: String
    default: ''

steps:
  - description: 'Deploy test Contour'
    plan: 'nest::kubernetes::deploy'
    parameters:
      service: 'ingress'
      app: 'contour'
      chart: 'contour/contour'
      namespace: 'test'
      repo_url: 'https://projectcontour.github.io/helm-charts/'
      version: '0.1.0'
      wait: true
      deploy: $deploy and $contour
      render_to: $render_to

  - description: 'Deploy test cert-manager'
    plan: 'nest::kubernetes::deploy'
    parameters:
      service: 'cert-manager'
      app: 'cert-manager'
      chart: 'oci://quay.io/jetstack/charts/cert-manager'
      namespace: 'test'
      version: '1.19.1'
      wait: true
      deploy: $deploy and $certmanager
      render_to: $render_to

  - description: 'Configure test CA'
    plan: 'nest::kubernetes::deploy'
    parameters:
      service: 'eyrie-ca'
      app: 'scratch'
      namespace: 'test'
      deploy: $deploy and $ca
      render_to: $render_to
